function[] = ImageProbeError2 ()
%collected positiones of imaged cross in RAS coordinate system. 
points = cat(3,[60.4336,11.4083,26.4598;
   59.1987,10.8755,26.8311;
   58.9739,10.2709,27.7293;
   59.458,11.2891,26.5991],[60.6742,10.3984,26.3495;
    60.4265,10.3341,24.0934;
    61.7196,11.4005,26.6389;
    60.1317,11.3149,25.3803],[57.9819,11.3587,26.6837;
    59.0784,11.5847,24.8535;
    58.7206,10.4498,26.3513;
    59.7264,12.0058,24.471],[59.8613,11.0137,26.6339;
    59.5484,11.5858,26.038;
    61.0274,10.9385,27.2059;
    60.0185,11.0946,26.5368],[60.0228,11.302,27.0927;
    58.7922,10.6158,25.1737;
    60.8008,11.1,26.8478;
    59.9907,11.5174,27.5505],[59.3822,9.6023,27.0479;
   58.592,11.928,26.3757;
   60.2054,10.6091,26.6394;
   58.8402,11.9819,26.1207],[60.8211,12.0119,26.4853;
   57.8735,11.7855,25.6533;
   60.3522,11.6003,26.2633;
   59.1808,11.8787,26.019],[61.1541,10.3071,25.8406;
   59.8319,10.3757,24.2734;
   61.1933,10.6562,26.1289;
   58.8484,12.321,26.1354],[62.1494,11.036,26.5505;
   58.1069,13.0318,25.1942;
   60.6795,11.3771,25.7357;
   58.8493,12.0164,27.46],[60.786,11.2737,26.419;
   59.0867,11.4969,26.7233;
   59.5408,11.3559,26.4402;
   58.0185,11.1993,26.6695]);
       
%ProbeToReference transforms. Each ProbeToReference transform correlates to
%a imaged cross point collected in the RAS
P2Rt = cat(3, [[0.995243     0.0860314     0.0457136     -32.862;
-0.0359886   -0.111381     0.993126      -67.6261;
0.0905321    -0.990047     -0.107755     -23.3825];
    [0.999925     0.01139      -0.00456115    -32.5403;
0.011807     -0.994382    0.105185       -4.06774;
-0.00333752  -0.105231    -0.994443      -55.3237];
    [0.989218     -0.0254684   -0.144217      -37.8154; 
-0.143194    0.0382371    -0.988956      37.7761;
0.0307024    0.998944     0.0341777      20.3318];
    [0.998939     0.0185529    -0.0421359     -36.6658; 
-0.0198085   0.999366     -0.029595      -32.142;
0.0415603    0.0303983    0.998674       51.9566]],[[0.985447     0.101837     0.136101       -33.5219; 
-0.129386    -0.069904    0.989127       -69.9576; 
0.110243     -0.992343    -0.0557105     -20.4563];
    [0.98169      -0.182435    -0.0548021     -41.1706; 
-0.183312    -0.982989    -0.0113825     11.2563; 
-0.0517928   0.0212198    -0.998433      -50.7887];
    [0.991371     0.034292     -0.126518      -37.1009; 
-0.129196    0.0924077    -0.987305      36.8049; 
-0.0221655   0.995131     0.0960408      22.3353];
    [0.992025     0.115807     0.0497487      -39.8836; 
-0.103226    0.972975     -0.206548      -24.9286; 
-0.0723249   0.199766     0.977171       53.5023]],[[0.990424     0.077955     0.113948       -36.1433;
-0.116768    0.0326098    0.992624       -59.8638; 
0.0736641    -0.996423    0.0414001      -15.7443];
    [0.995916     -0.080286    0.0412965      -29.307; 
-0.0829847   -0.994201    0.0684098      1.48433; 
0.0355644    -0.0715575   -0.996802      -52.7409];
    [0.976471     0.108291     -0.186487      -42.4931;
-0.1894      0.0171734    -0.98175       25.3267;
-0.103111    0.993971     0.0372794      19.0827];
    [0.988376     0.129277     -0.0800018     -28.2529;
-0.140356    0.978145     -0.153404      -30.1285; 
0.0584219    0.16285      0.98492        52.7962]],[[0.979817     0.12815      0.153407       -29.153;
-0.148506    -0.0470207   0.987793       -70.1351; 
0.133799     -0.99064     -0.0270408     -19.0248];
    [0.984911     -0.0880058   0.149013       -25.7648;
-0.102056    -0.990752    0.0894209      -6.20551;
0.139766     -0.103278    -0.984784      -52.0802];
    [0.981399     0.038431     -0.188095      -38.0378;
-0.190481    0.0726811    -0.978996      38.3693; 
-0.0239528   0.996615     0.0786493      21.8326];
    [0.984955     0.139349     -0.102196      -35.8616;
-0.154086    0.975927     -0.154347      -24.009;
0.078227     0.167773     0.982717       52.7071]],[[0.981785     0.131173     0.137452       -26.9933;
-0.128982    -0.0710585   0.989098       -67.8536;
0.13951      -0.98881     -0.0528451     -21.059];
    [0.993447     -0.109108    0.0340252      -40.5964;
-0.114099    -0.964014    -0.970147      -7.93333;  
0.00660183   -0.242429    0.24012        -54.634];
    [0.972457     -0.123624    -0.197596      -27.2993;
-0.195828    0.0264147    -0.980282      39.1902;
0.126406     0.991978     0.00147797     17.6286];
    [0.993042     0.117308     0.0103951      -38.0567;
-0.115691    0.988227     -0.100106      -22.0717;
-0.0220169   0.0982059    0.994922       52.809]],[[0.977791     0.068707    0.197999        -42.6241;
-0.187788    -0.132268   0.973262        -70.0544; 
0.0930581    -0.98883    -0.116428       -22.7687];
    [0.998413     0.0268301   0.0495194       -34.0751; 
0.00880032   -0.942757   0.333366        -24.8267;
0.0556284    -0.3324     -0.941496       -55.3044];
    [0.995074     -0.0538032  -0.0832639      -44.0663; 
-0.0830467   0.00626561  -0.996526       41.3486;
0.0541388    0.998533    0.00176653      18.1633];
    [0.995051     0.0973186   0.0200878       -38.2513; 
-0.0907744   0.972454    -0.214692       -20.4376; 
-0.040428    0.211806    0.976474        54.9127]],[[0.992987     0.0981124   0.0659461       -28.0668; 
-0.0811087   0.159607    0.983843        -76.1123; 
0.0860018    -0.982293   0.166445        -9.44612];
    [0.995154     -0.092501   -0.0333692      -41.4481; 
-0.0945844   -0.993228   -0.0674667      6.43665;
-0.0269025   0.0702952   -0.997164       -51.9348];
    [0.992952     -0.116674   -0.0207713      -30.3596;
-0.0457084   -0.21534    -0.975468       48.2262;
0.109339     0.969543    -0.219156       6.50326];
    [0.980047     0.198734    0.00356225      -35.2044;
-0.198334    0.976582    0.0833738       -39.5908;
0.0130905    -0.0824176  0.996512        50.0647]],[[0.987059     0.120178    0.106171        -37.9612;
-0.115544    0.0738976   0.990549        -75.2158;
0.111197     -0.989998   0.0868272       -12.7254];
    [0.987864     -0.155184   -0.00662318     -40.4315;
-0.155145    -0.987874   0.00603364      5.56392;
-0.00747916  -0.00493296 -0.99996        -51.3379];
    [0.985587     -0.000507328 -0.169164      -38.9194;
-0.168954    -0.0528002   -0.984209      42.064; 
-0.00843257  0.998604     -0.052125      14.3718];
    [0.993208     0.0955986    -0.0663178     -29.7039;
-0.103915    0.985237     -0.136049      -23.9468;
0.0523323    0.142017     0.98848        53.8816]],[[0.986339     0.111291     0.121446       -29.4084;
-0.109776    -0.105596    0.988331       -76.6389;
0.122817     -0.988162    -0.0919363     -22.2076];
    [0.994519     -0.104421    -0.0052745     -28.8139;
-0.104076    -0.983895    -0.145317      10.2068;
0.00998448   0.145069     -0.989372      -49.9314];
    [0.984169     -0.112206    -0.137189      -30.0207;
-0.136528    0.0135904    -0.990543      42.2552; 
0.11301      0.993592     -0.00194406    16.8055];
    [0.990236     0.0602946    -0.125687      -31.0371;
-0.111916    0.881404     -0.458913      -2.72835;
0.0831106    0.468498     0.879546       54.391]],[[0.978135     0.18926      0.0861987      -25.3126;
-0.067884    -0.101217    0.992546       -75.9815;
0.196574     -0.976697    -0.0861561     -21.9968];
    [0.992129     0.013308     0.124515       -31.6748;
-0.0385247   -0.913676    0.404614       -23.0538;
0.119151     -0.406226    -0.905971      -54.2664];
    [0.982587     -0.143837    -0.117613      -30.7977;
-0.136752    -0.131337    -0.98186       39.9438; 
0.125781     0.980848     -0.148719      9.8483];
    [0.992663     0.0423547    -0.113256      -37.3787;
-0.0586955   0.987676     -0.145088      -21.8569;
0.105716     0.150671     0.982916       54.382]]);

%ReferenceToRAS transform
R2RASt = [-0.0026   -0.0057   -1.0000  -16.1867;
   -0.9993    0.0374    0.0024   -8.0627;
    0.0374    0.9993   -0.0058 -110.8750];

%The ground truth position of the cross in the phantom. The position is
%collected in the RAS coordinate system
gt = [59.8889   15.1997   25.0408];

numCollectedDataSets = 10;
% file = fopen(filename);
% numCollectedDataSets(1,1) = fscanf(file, '%d', 1);

% points = zeros(4,3,numCollectedDataSets);
% P2Rt = zeros(12,4,numCollectedDataSets);
% R2RASt = zeros(3,4);
% gt = zeros(1,3);
% 
% for p=1:numCollectedDataSets
%     for i=1:4
%         for j=1:3
%             points(i,j,p) = fscanf(file, '%f', 1);
%             garbage = fscanf(file, '%c', 1);
%         end
%     end
% end
% 
% for p=1:numCollectedDataSets
%     for k=0:3:9
%         for i=1:4
%             for j=1:3
%                 P2Rt(j+k,i,p) = fscanf(file,'%f', 1);
%                 garbage = fscanf(file, '%c', 1);
%             end
%         end
%     end
% end
% 
% for p=1:4
%     for j=1:3
%         R2RASt(j,p) = fscanf(file, '%f', 1);
%         garbage = fscanf(file, '%c', 1);
%     end
% end
% 
% for i=1:3
%     gt(1,i) = fscanf(file, '%f', 1);
%     garbage = fscanf(file, '%c', 1);
% end

differences = zeros(4,3,5);
figure;

for j=1:numCollectedDataSets
    
    R2PtPoints = zeros(4,3);
    RAS2RtPoints = zeros(4,3);
    RAS2RtGround = zeros(4,3);
    R2PtGround = zeros(4,3);
    
    k = 1;
    for i=1:4
        
        %Move ground truth point and image cross points from RAS coordinate 
        %system to reference coordinate system
        RAS2RtGround(i,:) = R2RASt(:,1:3)\(gt') - R2RASt(:,4); 
        RAS2RtPoints(i,:) = R2RASt(:,1:3)\(points(i,:,j)') - R2RASt(:,4);

        %Move ground truth point and image cross points from reference
        %coordinate system to probe coordinate system
        R2PtGround(i,:) = P2Rt(k:k+2, 1:3, j)\(RAS2RtGround(i,:)') - P2Rt(k:k+2, 4, j);
        R2PtPoints(i,:) = P2Rt(k:k+2, 1:3, j)\(RAS2RtPoints(i,:)') - P2Rt(k:k+2, 4, j);

        k = k + 3;
        
        %Find and plot the difference between each imaged cross point and 
        %ground truth cross points transformed from RAS coordinate system 
        %to the Probe coordinate system
        differences(i,:,j) = R2PtPoints(i,:) - R2PtGround(i,:);
        plot3(differences(i,1,j), differences(i,2,j), differences(i,3,j), 'ro');
        hold on;
    end
end

avgDiff = [0,0,0]; %error in ImageToProbe transform
for i=1:numCollectedDataSets
    for j=1:4
        avgDiff = avgDiff + differences(j,:,i);
    end
end
avgDiff = avgDiff/(numCollectedDataSets * 4);

disp(differences);
disp('ImageToProbe transform error: ');
disp(avgDiff);

xlabel('x','FontSize',16);
ylabel('y','FontSize',16);
zlabel('z','FontSize',16);

end
